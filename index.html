<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘ç«¯å„¿ç«¥ä¹¦é¦†</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #6a1b9a;
            --accent-color: #ffca28;
            --bg-color: #f3f4f6;
            --text-color: #333;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        body, html {
            margin: 0;
            padding: 0;
            font-family: "Rounded Mplus 1c", "Microsoft YaHei", sans-serif;
            background-color: var(--bg-color);
            height: 100%;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-secondary { background: #eee; color: #555; }
        .btn-danger { background: #ef5350; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-copy { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb;}
        
        .hidden { display: none !important; }

        input[type="text"], textarea {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
            outline: none;
        }
        input:focus, textarea:focus { border-color: var(--primary-color); }

        /* åŠ è½½é®ç½©æ ·å¼ */
        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; color: var(--primary-color); font-weight: bold;
            flex-direction: column; gap: 10px;
        }

        #login-layer {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100vh; background: linear-gradient(135deg, #ede7f6 0%, #fff 100%);
            position: fixed; width: 100%; z-index: 999;
        }
        
        .login-box {
            background: white; padding: 50px 40px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center;
            width: 90%; max-width: 380px;
        }
        
        .login-box h2 { margin-bottom: 30px; color: var(--primary-color); }
        .login-input { margin-bottom: 20px; font-size: 16px; text-align: center; letter-spacing: 2px; }

        #shelf-layer { padding: 20px; max-width: 1200px; margin: 0 auto; min-height: 100vh; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .shelf-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 25px; }
        .book-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: var(--card-shadow); cursor: pointer; transition: transform 0.2s; position: relative; }
        .book-card:hover { transform: translateY(-5px); }
        .book-cover { width: 100%; aspect-ratio: 3/4; object-fit: cover; background: #eee; }
        .book-info { padding: 12px; text-align: center; }
        .book-title { font-weight: bold; color: var(--text-color); margin: 0; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .empty-state { text-align: center; color: #999; margin-top: 100px; grid-column: 1 / -1; }

        #admin-layer { padding: 20px; max-width: 800px; margin: 0 auto; padding-bottom: 100px; }
        .admin-header { display: flex; flex-direction: column; margin-bottom: 20px; background: white; padding: 20px; border-radius: 10px; box-shadow: var(--card-shadow); gap: 15px; }
        .admin-header-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .admin-code-bar { background: #e8eaf6; padding: 10px; border-radius: 6px; color: #3f51b5; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        
        .editor-section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid var(--primary-color); }
        .cover-preview { width: 100px; height: 133px; object-fit: cover; background: #eee; border-radius: 5px; margin-top: 10px; display: block; }
        .page-list-item { display: flex; align-items: center; gap: 15px; background: #f9f9f9; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #eee; }
        .page-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; background: #ddd; }

        #reader-layer { height: 100vh; width: 100vw; overflow: hidden; background: #fff; }
        .book-layout { display: flex; height: 100%; }
        .text-panel { flex: 1; padding: 40px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fff; position: relative; z-index: 10; }
        .image-panel { flex: 1.5; background: #f0f0f0; display: flex; justify-content: center; align-items: center; }
        .image-panel img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .reader-controls { margin-top: 30px; display: flex; gap: 15px; align-items: center; }
        .nav-btn-group { display: flex; gap: 10px; }

        .save-bar {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #ddd;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .book-layout { flex-direction: column; }
            .image-panel { flex: 1.2; order: 1; background: #000;}
            .text-panel { flex: 0.8; order: 2; padding: 20px; font-size: 16px;}
            .reader-controls { margin-top: 15px; flex-wrap: wrap; justify-content: center;}
            .admin-header-top { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div id="loading-mask" class="hidden">
        <div id="loading-text">â˜ï¸ æ­£åœ¨è¿æ¥äº‘ç«¯ä¹¦åº“...</div>
        <div style="font-size:12px; font-weight:normal; color:#666;" id="loading-sub"></div>
    </div>

    <div id="login-layer">
        <div class="login-box">
            <h2>â˜ï¸ äº‘ç«¯å„¿ç«¥ä¹¦é¦† (é«˜æ¸…ç‰ˆ)</h2>
            <input type="text" id="card-code" class="login-input" placeholder="è¯·è¾“å…¥é˜…è¯»å¡å¯†">
            <br>
            <button class="btn btn-primary" style="width:100%; font-size:16px;" onclick="handleLogin()">å¼€å¯é˜…è¯»ä¹‹æ—…</button>
        </div>
    </div>

    <div id="shelf-layer" class="hidden">
        <header>
            <h2 style="color: var(--primary-color);">ğŸ“š äº‘ç«¯ä¹¦æ¶</h2>
            <button class="btn btn-secondary" onclick="logout()">é€€å‡º</button>
        </header>
        <div id="book-grid" class="shelf-grid"></div>
    </div>

    <div id="admin-layer" class="hidden">
        <div class="admin-header">
            <div class="admin-header-top">
                <h3 style="margin:0;">ğŸ› ï¸ é¦†é•¿ç®¡ç†åå°</h3>
                <div>
                    <button class="btn btn-secondary" onclick="showShelf()">é¢„è§ˆä¹¦æ¶</button>
                    <button class="btn btn-secondary" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>
            <div class="admin-code-bar">
                <span>ğŸ”‘ <strong>ç”¨æˆ·å¡å¯†ï¼š</strong> <span id="admin-view-code">VIP-8888-READ-NOW</span></span>
                <button class="btn btn-copy" style="font-size:12px; padding:5px 10px;" onclick="copyUserCode()">å¤åˆ¶</button>
            </div>
            </div>

        <div id="admin-book-list">
            <button class="btn btn-primary" style="width:100%; margin-bottom:20px; padding: 15px;" onclick="createNewBook()">+ æ–°å»ºç»˜æœ¬</button>
            <div id="admin-books-container"></div>
        </div>

        <div id="book-editor" class="hidden">
            <div class="editor-section">
                <h4>1. ç»˜æœ¬åŸºæœ¬ä¿¡æ¯</h4>
                <label>åç§°ï¼š</label> <input type="text" id="edit-book-title">
                <br><br>
                <label>å°é¢ï¼š</label> <input type="file" id="edit-book-cover-input" accept="image/*" onchange="previewCover(this)">
                <img id="edit-book-cover-preview" class="cover-preview" src="">
            </div>
            <div class="editor-section">
                <h4>2. å†…å®¹é¡µç®¡ç†</h4>
                <div id="editor-pages-area"></div>
            </div>
            <div class="editor-section" style="border-left-color: var(--accent-color);">
                <h4>3. æ–°å¢ä¸€é¡µ</h4>
                <input type="file" id="new-page-img" accept="image/*" style="margin-bottom: 10px;">
                <textarea id="new-page-text" placeholder="è¾“å…¥æœ¬é¡µæ•…äº‹æ–‡æ¡ˆ..."></textarea>
                <br><br>
                <button class="btn btn-primary" onclick="addPageToEditor()">+ ç¡®è®¤æ·»åŠ æ­¤é¡µ</button>
            </div>
            
            <div class="save-bar">
                <button class="btn btn-success" style="width:100%; padding: 15px; font-size: 16px;" onclick="saveCurrentBookInfoOnly()">ğŸ’¾ ä¿å­˜æ‰€æœ‰ä¿¡æ¯åˆ°äº‘ç«¯</button>
                <button class="btn btn-secondary" style="width:100%" onclick="closeEditor()">è¿”å›ç»˜æœ¬åˆ—è¡¨</button>
            </div>
        </div>
    </div>

    <div id="reader-layer" class="hidden">
        <div class="book-layout">
            <div class="text-panel">
                <div id="reader-text" style="font-size: 1.2em; line-height: 1.6; text-align: left; width: 100%;"></div>
                <div class="reader-controls">
                    <button class="btn btn-primary" id="play-btn" onclick="toggleAudio()">ğŸ”Š æ’­æ”¾</button>
                    <div class="nav-btn-group">
                        <button class="btn btn-secondary" id="prev-btn" onclick="prevPage()">ä¸Šä¸€é¡µ</button>
                        <button class="btn btn-primary" id="next-btn" onclick="nextPage()">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
                <button class="btn btn-secondary" style="margin-top: 20px; font-size: 12px;" onclick="closeReader()">é€€å‡ºé˜…è¯»</button>
                <div style="margin-top: 15px; color:#999; font-size: 14px;">ç¬¬ <span id="reader-page-num">1</span> é¡µ / å…± <span id="reader-total">1</span> é¡µ</div>
            </div>
            <div class="image-panel"><img id="reader-img" src="" alt=""></div>
        </div>
    </div>

    <script>
        // ============================================
        // âš ï¸ Supabase é…ç½® âš ï¸
        // ============================================
        const SUPABASE_URL = 'https://dkfjkfutkkmxxsplejyx.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_5PdiGDQTQKcwI2NwtPsNHA_Dm4CJ-iu';
        
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        const USER_ACCESS_CODE = "VIP-8888-READ-NOW"; 
        const ADMIN_ACCESS_CODE = "admintan"; 

        let libraryData = []; 
        let currentEditingBook = null;
        let currentReadingBook = null;
        let currentReadingPage = 0;
        let audioPlayer = new Audio();
        let isPlaying = false;
        let audioCache = {}; 

        window.onload = function() {
            document.getElementById('admin-view-code').innerText = USER_ACCESS_CODE;
        };

        function switchLayer(layerId) {
            ['login-layer', 'shelf-layer', 'admin-layer', 'reader-layer'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(layerId).classList.remove('hidden');
        }

        // --- æ ¸å¿ƒä¼˜åŒ–ï¼šå‡è¡¡å‹ç¼© (Width 1024, Quality 0.6) ---
        // ç›®æ ‡ï¼šå›¾ç‰‡å¤§å°æ§åˆ¶åœ¨ 100kb - 200kb ä¹‹é—´ï¼Œä¿è¯æ¸…æ™°åº¦
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function(event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // æ¸…æ™°åº¦ä¼˜åŒ–ï¼šæœ€å¤§å®½åº¦è°ƒæ•´ä¸º 1024px
                        const MAX_WIDTH = 1024; 
                        let width = img.width;
                        let height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        
                        canvas.width = width; 
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // è´¨é‡è®¾ä¸º 0.6ï¼Œå¹³è¡¡ä½“ç§¯å’Œç”»è´¨
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        // --- äº‘ç«¯æ•°æ®é€»è¾‘ ---
        async function fetchLibraryFromCloud() {
            showLoading(true, "â˜ï¸ æ­£åœ¨è¿æ¥äº‘ç«¯ä¹¦åº“...");
            const { data, error } = await db.from('library_storage').select('data').eq('id', 1).single();
            showLoading(false);
            
            if (error) {
                if(error.code === 'PGRST116') return true; 
                console.error("åŠ è½½é”™è¯¯:", error); 
                return false;
            }
            if (data && data.data) { libraryData = data.data; return true; }
            return true;
        }

        async function saveLibraryToCloud() {
            showLoading(true, "â˜ï¸ æ­£åœ¨ä¸Šä¼ åˆ°äº‘ç«¯...", "(å›¾ç‰‡è´¨é‡å·²ä¼˜åŒ–)");
            
            const { error } = await db.from('library_storage').upsert({ id: 1, data: libraryData });
            showLoading(false);
            
            if (error) {
                console.error("ä¿å­˜é”™è¯¯:", error);
                if(error.code === '57014') {
                    alert("âš ï¸ ä¸Šä¼ è¶…æ—¶ï¼\nå›¾ç‰‡è¿˜æ˜¯æœ‰ç‚¹å¤šï¼Œå»ºè®®åˆ†æ‰¹ä¿å­˜ï¼Œæˆ–è€…åˆ é™¤ä¸€ä¸¤æœ¬æ—§ä¹¦ã€‚");
                } else {
                    alert("ä¿å­˜å¤±è´¥ï¼ä»£ç : " + error.code + "\n" + error.message);
                }
            } else {
                console.log('åŒæ­¥æˆåŠŸ');
                alert("âœ… ä¿å­˜æˆåŠŸï¼ç”»è´¨å·²æå‡ã€‚");
            }
        }

        function showLoading(show, text, subText="") {
            const el = document.getElementById('loading-mask');
            if(show) {
                document.getElementById('loading-text').innerText = text;
                document.getElementById('loading-sub').innerText = subText;
                el.classList.remove('hidden');
            } else { el.classList.add('hidden'); }
        }
        
        // --- ç™»å½•/é€€å‡º ---
        async function handleLogin() {
            const codeInput = document.getElementById('card-code').value.trim();
            const success = await fetchLibraryFromCloud();
            if(!success) {
                if(codeInput === ADMIN_ACCESS_CODE) {
                    if(confirm("äº‘ç«¯è¿æ¥ä¼¼ä¹æœ‰é—®é¢˜ï¼Œæ˜¯å¦å¼ºè¡Œè¿›å…¥åå°ï¼Ÿ")) {
                        switchLayer('admin-layer'); renderAdminBookList(); return;
                    }
                }
                alert("è¿æ¥äº‘ç«¯å¤±è´¥");
                return;
            }

            if (codeInput === ADMIN_ACCESS_CODE) { switchLayer('admin-layer'); renderAdminBookList(); } 
            else if (codeInput === USER_ACCESS_CODE) { switchLayer('shelf-layer'); renderShelf(); } 
            else { alert("å¡å¯†æ— æ•ˆ"); }
        }

        function logout() { stopAudio(); switchLayer('login-layer'); document.getElementById('card-code').value = ''; libraryData = []; }
        function copyUserCode() { navigator.clipboard.writeText(USER_ACCESS_CODE).then(() => alert("å¡å¯†å·²å¤åˆ¶")); }

        // --- ä¹¦æ¶ & ç®¡ç† ---
        function renderShelf() {
            const container = document.getElementById('book-grid');
            container.innerHTML = '';
            if (libraryData.length === 0) { container.innerHTML = `<div class="empty-state"><h3>ğŸ“­ ä¹¦æ¶ç©ºç©ºå¦‚ä¹Ÿ</h3><p>è€å¸ˆæ­£åœ¨å‡†å¤‡ä¸­...</p></div>`; return; }
            libraryData.forEach(book => {
                const cover = book.cover || (book.pages.length > 0 ? book.pages[0].img : 'https://via.placeholder.com/300x400?text=No+Cover');
                const div = document.createElement('div');
                div.className = 'book-card';
                div.onclick = () => openReader(book.id);
                div.innerHTML = `<img src="${cover}" class="book-cover"><div class="book-info"><div class="book-title">${book.title}</div></div>`;
                container.appendChild(div);
            });
        }
        function showShelf() { switchLayer('shelf-layer'); renderShelf(); }

        function renderAdminBookList() {
            document.getElementById('admin-book-list').classList.remove('hidden');
            document.getElementById('book-editor').classList.add('hidden');
            const container = document.getElementById('admin-books-container');
            container.innerHTML = '';
            libraryData.forEach((book, index) => {
                const div = document.createElement('div');
                div.style = "background:white; padding:15px; margin-bottom:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 4px rgba(0,0,0,0.05);";
                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="${book.cover || 'https://via.placeholder.com/50'}" style="width:40px; height:40px; object-fit:cover; border-radius:4px;">
                        <span><strong>${book.title}</strong> (${book.pages.length} é¡µ)</span>
                    </div>
                    <div>
                        <button class="btn btn-secondary" onclick="editBook(${index})">ç¼–è¾‘</button>
                        <button class="btn btn-danger" onclick="deleteBook(${index})">åˆ é™¤</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function createNewBook() { currentEditingBook = { id: Date.now(), title: "", cover: "", pages: [] }; openEditorUI(); }
        function editBook(index) { currentEditingBook = JSON.parse(JSON.stringify(libraryData[index])); openEditorUI(); }
        async function deleteBook(index) { if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) { libraryData.splice(index, 1); await saveLibraryToCloud(); renderAdminBookList(); } }

        function openEditorUI() {
            document.getElementById('admin-book-list').classList.add('hidden');
            document.getElementById('book-editor').classList.remove('hidden');
            document.getElementById('edit-book-title').value = currentEditingBook.title;
            document.getElementById('edit-book-cover-preview').src = currentEditingBook.cover || 'https://via.placeholder.com/100x133?text=Cover';
            document.getElementById('edit-book-cover-input').value = '';
            renderEditorPages();
            document.getElementById('new-page-img').value = '';
            document.getElementById('new-page-text').value = '';
        }

        async function previewCover(input) {
            if (input.files && input.files[0]) {
                try {
                    const compressedBase64 = await compressImage(input.files[0]);
                    document.getElementById('edit-book-cover-preview').src = compressedBase64;
                    currentEditingBook.cover = compressedBase64;
                } catch (e) { alert("å›¾ç‰‡å¤„ç†å¤±è´¥"); }
            }
        }

        async function saveCurrentBookInfoOnly() {
            currentEditingBook.title = document.getElementById('edit-book-title').value || "æœªå‘½åç»˜æœ¬";
            updateLocalData();
            await saveLibraryToCloud();
        }

        function renderEditorPages() {
            const container = document.getElementById('editor-pages-area');
            container.innerHTML = '';
            currentEditingBook.pages.forEach((page, idx) => {
                const div = document.createElement('div');
                div.className = 'page-list-item';
                div.innerHTML = `
                    <span style="background:var(--primary-color); color:white; padding:2px 8px; border-radius:10px; font-size:12px;">P${idx + 1}</span>
                    <img src="${page.img}" class="page-thumb">
                    <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${page.text}</div>
                    <button class="btn btn-danger" onclick="deletePageFromEditor(${idx})">åˆ é™¤</button>
                `;
                container.appendChild(div);
            });
        }

        async function addPageToEditor() {
            const fileInput = document.getElementById('new-page-img');
            const textInput = document.getElementById('new-page-text');
            if (fileInput.files.length === 0 || !textInput.value.trim()) { alert("è¯·å¡«å†™å®Œæ•´"); return; }
            showLoading(true, "æ­£åœ¨å¤„ç†å›¾ç‰‡å¹¶ä¸Šä¼ ...", "è¯·ç¨å€™");
            try {
                const compressedBase64 = await compressImage(fileInput.files[0]);
                currentEditingBook.pages.push({ img: compressedBase64, text: textInput.value.trim() });
                renderEditorPages();
                updateLocalData();
                await saveLibraryToCloud(); // æ¯æ¬¡æ·»åŠ è‡ªåŠ¨ä¿å­˜
                textInput.value = ''; fileInput.value = '';
            } catch (e) { alert("å›¾ç‰‡ä¸Šä¼ å¤±è´¥"); showLoading(false); }
        }

        async function deletePageFromEditor(idx) { currentEditingBook.pages.splice(idx, 1); renderEditorPages(); updateLocalData(); await saveLibraryToCloud(); }
        function closeEditor() { renderAdminBookList(); }

        function updateLocalData() {
            const existingIdx = libraryData.findIndex(b => b.id === currentEditingBook.id);
            if (existingIdx >= 0) libraryData[existingIdx] = currentEditingBook;
            else libraryData.push(currentEditingBook);
        }

        // --- é˜…è¯»å™¨ ---
        function openReader(bookId) {
            currentReadingBook = libraryData.find(b => b.id === bookId);
            if (!currentReadingBook) return;
            if (currentReadingBook.pages.length === 0) { alert("æ²¡æœ‰å†…å®¹"); return; }
            
            currentReadingPage = 0;
            audioCache = {}; 
            
            switchLayer('reader-layer');
            loadReaderPage();
        }

        function loadReaderPage() {
            const page = currentReadingBook.pages[currentReadingPage];
            const total = currentReadingBook.pages.length;
            document.getElementById('reader-img').src = page.img;
            document.getElementById('reader-text').innerText = page.text;
            document.getElementById('reader-page-num').innerText = currentReadingPage + 1;
            document.getElementById('reader-total').innerText = total;
            
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            prevBtn.disabled = (currentReadingPage === 0);
            
            if (currentReadingPage === total - 1) {
                nextBtn.innerText = "ğŸ‰ å·²å®Œç»“";
                nextBtn.onclick = () => { if(confirm("é‡è¯»ä¸€éï¼Ÿ")) { currentReadingPage = 0; loadReaderPage(); } else { closeReader(); } };
            } else {
                nextBtn.innerText = "ä¸‹ä¸€é¡µ"; 
                nextBtn.onclick = () => nextPage(false); 
            }
            stopAudio();
        }

        function nextPage(autoPlay = false) { 
            if (currentReadingPage < currentReadingBook.pages.length - 1) { 
                currentReadingPage++; 
                loadReaderPage(); 
                if(autoPlay) {
                    setTimeout(playTTS, 500);
                }
            } 
        }
        
        function prevPage() { if (currentReadingPage > 0) { currentReadingPage--; loadReaderPage(); } }
        function closeReader() { stopAudio(); switchLayer('shelf-layer'); }
        function toggleAudio() { if (isPlaying) stopAudio(); else playTTS(); }

        // --- é¢„åŠ è½½ ---
        async function preloadAudio(pageIndex) {
            if (pageIndex >= currentReadingBook.pages.length) return;
            if (audioCache[pageIndex]) return;

            const text = currentReadingBook.pages[pageIndex].text;
            if (!text) return;

            const baseUrl = "https://api.pearktrue.cn/api/freedub";
            const params = new URLSearchParams({ text: text, role: "zh-CN-XiaoyiNeural", style: "cheerful" });

            try {
                const response = await fetch(`${baseUrl}?${params.toString()}`);
                const data = await response.json();
                if (data.code === 200 && data.data && data.data.audio_url) {
                    audioCache[pageIndex] = data.data.audio_url;
                }
            } catch (e) { }
        }

        function playTTS() {
            const text = currentReadingBook.pages[currentReadingPage].text;
            const btn = document.getElementById('play-btn');
            if (!text) return;
            
            if (audioCache[currentReadingPage]) {
                playUrl(audioCache[currentReadingPage], btn);
            } else {
                btn.innerText = "â³ åŠ è½½ä¸­...";
                const baseUrl = "https://api.pearktrue.cn/api/freedub";
                const params = new URLSearchParams({ text: text, role: "zh-CN-XiaoyiNeural", style: "cheerful" });
                
                fetch(`${baseUrl}?${params.toString()}`).then(response => response.json()).then(data => {
                    if (data.code === 200 && data.data && data.data.audio_url) {
                        audioCache[currentReadingPage] = data.data.audio_url;
                        playUrl(data.data.audio_url, btn);
                    } else { btn.innerText = "ğŸ”Š æ’­æ”¾"; }
                }).catch(err => { btn.innerText = "ğŸ”Š æ’­æ”¾"; });
            }
            preloadAudio(currentReadingPage + 1);
        }

        function playUrl(url, btn) {
            audioPlayer.src = url;
            audioPlayer.play().then(() => { 
                isPlaying = true; 
                btn.innerText = "â¸ åœæ­¢"; 
            }).catch(e => { btn.innerText = "âŒ å¤±è´¥"; });

            audioPlayer.onended = function() {
                isPlaying = false;
                btn.innerText = "ğŸ”Š æ’­æ”¾";
                if (currentReadingPage < currentReadingBook.pages.length - 1) {
                    nextPage(true); 
                }
            };
        }

        function stopAudio() { 
            audioPlayer.pause(); 
            audioPlayer.currentTime = 0; 
            isPlaying = false; 
            document.getElementById('play-btn').innerText = "ğŸ”Š æ’­æ”¾"; 
        }
    </script>
</body>
</html>
